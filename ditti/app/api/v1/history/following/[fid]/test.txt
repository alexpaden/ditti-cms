// app/api/v1/history/following/service.ts
import { indexerClient } from "@/app/database";

export async function getRecentChangesByFid(fid: string) {
  const trackerEntries = await getFollowingTrackerEntriesByFid(fid);
  const recentTrackers = trackerEntries.slice(-10);

  const fids: number[] = [
    ...new Set(
      recentTrackers.reduce(
        (acc, entry) => [...acc, ...entry.added, ...entry.removed],
        []
      )
    ),
  ].slice(-10);

  console.log("the fids are ", fids);

  const profiles = await getFarcasterProfilesByFids(fids);
  console.log("here the profiles ", profiles);
  return fids;
}

export async function getFollowingTrackerEntriesByFid(fid: string) {
  const { data, error } = await cmsClient
    .from("following_trackers")
    .select("created_at, added, removed")
    .eq("fid", parseInt(fid, 10))
    .order("id", { ascending: true });

  if (error) {
    console.error("Error fetching following tracker entries:", error);
    throw error;
  }

  return data;
}

export async function getFarcasterProfilesByFids(fids: number[]) {
  const { data, error } = await indexerClient
    .from("profile")
    .select("id, username, avatar_url")
    .eq("id", 533);

  if (error) {
    console.error("Error fetching profiles:", error);
    throw error;
  }

  return data;
}
